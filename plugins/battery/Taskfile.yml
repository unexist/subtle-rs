version: '3'

vars:
  BINARY: 'battery'
  DISTPATH: './target/wasm32-unknown-unknown/release/'

tasks:
  build:
    cmds:
      - cargo build --target wasm32-unknown-unknown --release

  debug:
    cmds:
      - task: build
      - cp {{.DISTPATH}}/{{.BINARY}}.wasm .

  optimize:
    cmds:
      - wasm-opt -Os {{.DISTPATH}}/{{.BINARY}}.wasm --output ./{{.BINARY}}.wasm

  strip:
    cmds:
      - wasm-strip ./{{.BINARY}}.wasm

  run:
    cmds:
      - extism call ./{{.BINARY}}.wasm run

  sizes:
    cmds:
      - du -shc **/*.wasm

  default:
    cmds:
      - task: build
      - task: optimize
      - task: strip